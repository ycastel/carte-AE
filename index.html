<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Carte des écoles</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css"/>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        #map { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <!-- PapaParse pour lire le CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Proj4 pour la conversion Lambert93 -> WGS84 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

    <script>
        // Initialisation de la carte centrée sur la Côte d'Azur
        var map = L.map('map').setView([43.68, 6.02], 8);

        // Ajout du fond de carte OpenStreetMap
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: 'Data © <a href="http://openstreetmap.org">OpenStreetMap</a>',
            maxZoom: 18
        }).addTo(map);

        // Définition de la projection Lambert-93 et WGS84
        proj4.defs("EPSG:2154","+proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +units=m +no_defs");

        // Fonction pour convertir Lambert-93 -> WGS84
        function lambert93ToWGS84(x, y) {
            return proj4('EPSG:2154', 'EPSG:4326', [x, y]);
        }

        // Charger le CSV
        Papa.parse("ecoles.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(function(row) {
                    if(row.lon && row.lat) {
                        var coords = lambert93ToWGS84(parseFloat(row.lon), parseFloat(row.lat));
                        var lat = coords[1];
                        var lon = coords[0];

                        // Création du marker
                        var marker = L.circleMarker([lat, lon], {
                            color: "blue",
                            fillColor: "blue",
                            fillOpacity: 0.8,
                            radius: 6,
                            weight: 2
                        }).addTo(map);

                        // Contenu du popup
                        var html = `<b>${row.Nom_ecole}</b><br>${row.Adresse}<br>${row.CP} ${row.Commune}`;
                        if(row.site_web) html += `<br><a href="${row.site_web}" target="_blank">Site web</a>`;

                        marker.bindPopup(html);
                    }
                });
            }
        });
    </script>
</body>
</html>